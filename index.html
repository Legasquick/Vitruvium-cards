<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ v4.8 (Final)</title>
    <style>
        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
        :root {
            --card-width: 63mm;
            --card-height: 88mm;
            --border-color: #000;
            --accent-color: #007bff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f0f0f0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* --- –°–ü–ò–°–û–ö –ö–ê–†–¢–û–ß–ï–ö --- */
        .cards-list { display: grid; grid-template-columns: repeat(auto-fill, var(--card-width)); gap: 15px; justify-content: center; }
        .card-item { position: relative; }
        
        /* --- –ö–ê–†–¢–û–ß–ö–ê-–î–û–ë–ê–í–õ–Ø–õ–ö–ê --- */
        .card-adder {
            width: var(--card-width); height: var(--card-height); border: 3px dashed #ccc;
            border-radius: 5px; display: flex; justify-content: center; align-items: center;
            font-size: 80px; color: #ccc; cursor: pointer; transition: all 0.3s;
        }
        .card-adder:hover { color: #aaa; border-color: #aaa; transform: scale(1.02); }

        /* --- –°–¢–ò–õ–ò –ö–ê–†–¢–û–ß–ö–ò --- */
        .card {
            border: 3px solid var(--border-color); /* –ï–¥–∏–Ω–∞—è —á–µ—Ä–Ω–∞—è —Ä–∞–º–∫–∞ */
            width: var(--card-width); height: var(--card-height); display: flex; flex-direction: column;
            user-select: none; transition: box-shadow 0.3s, border-color 0.3s;
            overflow: hidden; 
        }
        .card:has([contenteditable="true"]:focus) { box-shadow: 0 0 10px 3px var(--accent-color); }
        .card-header { 
            color: white; padding: 12px; display: flex; align-items: center; gap: 10px; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-title, .card-subtitle { word-break: keep-all; overflow-wrap: normal; }
        .card-title {
            flex: 1; min-width: 0; font-size: 20px; font-weight: bold; text-transform: uppercase;
            letter-spacing: 1.5px; line-height: 1.2; text-align: left;
        }
        .card-icon {
            flex-shrink: 0; width: 40px; display: flex; justify-content: center; align-items: center;
            font-size: 28px; cursor: pointer; transition: transform 0.3s; border-radius: 4px;
        }
        .card-icon:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); }
        .card-subtitle {
            color: #E0E0E0; padding: 6px 12px; font-size: 12px; text-transform: uppercase;
            letter-spacing: 1px; min-height: 18px; line-height: 1.2;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-content {
            background: #FFFFFF;
            padding: 15px; flex: 1; font-size: 10px; line-height: 1.5; color: var(--border-color); overflow: auto;
        }
        
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–£–ï–ú–´–• –≠–õ–ï–ú–ï–ù–¢–û–í --- */
        [contenteditable="true"] { cursor: text; outline: none; }
        [contenteditable="true"]:focus { background: rgba(0, 0, 0, 0.05); box-shadow: 0 0 0 2px var(--accent-color) inset; border-radius: 2px; }
        [contenteditable="true"][data-placeholder]:empty::before { content: attr(data-placeholder); color: #888; pointer-events: none; font-style: italic; opacity: 0.8; }
        [contenteditable="true"][data-placeholder]:empty:focus::before { content: ""; }

        /* --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–û–ô --- */
        .card-controls { position: absolute; bottom: -25px; left: 0; right: 0; display: flex; justify-content: center; gap: 5px; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .card-item:hover .card-controls { opacity: 1; bottom: -10px; pointer-events: all; }
        .card-controls button { padding: 4px 8px; font-size: 12px; font-weight: normal; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .copy-btn { background: #28a745; }
        .delete-btn { background: #dc3545; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –¢–ò–ü–ê --- */
        #iconModal {
            position: absolute; display: none; z-index: 1000; background: white; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 320px; padding: 15px; border: 1px solid #ccc;
        }
        #modalBackdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: none; }
        #iconModal h3 { margin-top: 0; margin-bottom: 15px; text-align: center; }
        .icon-selector { display: flex; flex-direction: column; gap: 10px; }
        .icon-option {
            display: flex; align-items: center; gap: 15px; padding: 10px;
            border: 2px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;
        }
        .icon-option:hover { border-color: var(--border-color); background: #f5f5f5; }
        .icon-emoji-box {
            font-size: 28px; width: 50px; height: 40px; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid #eee; border-radius: 4px; background: #fafafa;
        }
        .icon-label { font-size: 16px; font-weight: bold; }
        
        /* --- –û–ë–©–ò–ï –ö–ù–û–ü–ö–ò --- */
        .global-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 50px; }
        .global-buttons button { padding: 12px 24px; background: var(--border-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–ï–ß–ê–¢–ò --- */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container { max-width: none; padding: 0; box-shadow: none; margin: 0; }
            .global-buttons, h1, h2, .card-controls, .card-adder { display: none !important; }
            .cards-list { display: grid; grid-template-columns: repeat(3, var(--card-width)); gap: 0; padding: 0; margin: 0; justify-content: center; }
            .card-item { break-inside: avoid; page-break-inside: avoid; }
            .card, .card-header, .card-subtitle, .card-content {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            @page { size: A4 portrait; margin: 10mm; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–≥—Ä–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>
        <h2>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (<span id="cardCount">0</span>):</h2>
        <div id="cardsList" class="cards-list"></div>

        <div class="global-buttons">
            <button onclick="printCards()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button onclick="saveJSON()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
            <button onclick="loadJSON()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
            <button onclick="clearAll()" style="background: #dc3545;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modalBackdrop"></div>
    <div id="iconModal">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
        <div class="icon-selector" id="modalIconSelector"></div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let cards = [];
        const defaultIconTypes = [
            { icon: 'üì¶', type: '–ü—Ä–µ–¥–º–µ—Ç' },
            { icon: '‚ö°', type: '–≠—Ñ—Ñ–µ–∫—Ç' },
            { icon: 'üé≠', type: '–ß–µ—Ä—Ç–∞' },
            { icon: '‚≠ê', type: '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å' },
            { icon: 'üêæ', type: '–°—É—â–µ—Å—Ç–≤–æ' }
        ];
        
        const CARD_THEME_COLORS = {
            '–ü—Ä–µ–¥–º–µ—Ç': { main: '#000000', sub: '#333333' },
            '–≠—Ñ—Ñ–µ–∫—Ç': { main: '#4B0082', sub: '#6A5ACD' },
            '–ß–µ—Ä—Ç–∞': { main: '#006400', sub: '#2E8B57' },
            '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å': { main: '#AF9500', sub: '#D4AF37' },
            '–°—É—â–µ—Å—Ç–≤–æ': { main: '#8B0000', sub: '#A52A2A' }
        };

        let modalEditingIndex = null;
        let ruler;

        // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
        const cardsList = document.getElementById('cardsList');
        const fileInput = document.getElementById('fileInput');
        const cardCountEl = document.getElementById('cardCount');
        const iconModal = document.getElementById('iconModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalIconSelector = document.getElementById('modalIconSelector');

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            ruler = document.createElement('span');
            ruler.style.position = 'absolute'; ruler.style.visibility = 'hidden'; ruler.style.whiteSpace = 'nowrap';
            document.body.appendChild(ruler);
            renderCardsList();
            setupModalListeners();
        });

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML ---
        function createCardHTML(cardData, index) {
            const { title = '', icon = 'üì¶', type = '–ü—Ä–µ–¥–º–µ—Ç', subtitle = '', description = '' } = cardData;
            const theme = CARD_THEME_COLORS[type] || CARD_THEME_COLORS['–ü—Ä–µ–¥–º–µ—Ç'];
            const formattedDescription = description.replace(/\n/g, '<br>');
            return `
                <div class="card" data-index="${index}">
                    <div class="card-header" style="background-color: ${theme.main}; border-bottom: 3px solid ${theme.main};">
                        <div class="card-title" contenteditable="true" data-placeholder="[–ù–∞–∑–≤–∞–Ω–∏–µ]">${title}</div>
                        <div class="card-icon">${icon}</div>
                    </div>
                    <div class="card-subtitle" style="background-color: ${theme.sub}; border-bottom: 3px solid ${theme.main};" contenteditable="true" data-placeholder="[–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫]">${subtitle}</div>
                    <div class="card-content" contenteditable="true" data-placeholder="[–û–ø–∏—Å–∞–Ω–∏–µ...]">${formattedDescription}</div>
                </div>
                <div class="card-controls">
                    <button class="copy-btn" onclick="copyCard(${index})">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="delete-btn" onclick="deleteCard(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>`;
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì ---
        function renderCardsList() {
            const scrollY = window.scrollY;
            cardsList.innerHTML = '';
            cardCountEl.textContent = cards.length;

            const adder = document.createElement('div');
            adder.className = 'card-adder'; adder.textContent = '‚úö'; adder.title = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É';
            adder.onclick = addNewCard;
            cardsList.appendChild(adder);

            cards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                cardItem.innerHTML = createCardHTML(card, index);
                cardsList.appendChild(cardItem);
                
                adjustFontSize(cardItem.querySelector('.card-title'));
                adjustFontSize(cardItem.querySelector('.card-subtitle'));
            });

            attachCardListeners();
            window.scrollTo(0, scrollY);
        }
        
        // --- CRUD ---
        function addNewCard() {
            const defaultType = defaultIconTypes[0];
            const newCard = {
                title: '', type: defaultType.type, icon: defaultType.icon,
                subtitle: '', description: ''
            };
            cards.unshift(newCard);
            renderCardsList();
            const newCardTitleEl = cardsList.querySelector('.card[data-index="0"] .card-title');
            if (newCardTitleEl) newCardTitleEl.focus();
        }
        
        /**
         * --- –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
         * –£–¥–∞–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ä–∞–∑—É, –±–µ–∑ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞.
         */
        function deleteCard(index) {
            cards.splice(index, 1);
            renderCardsList();
        }
        
        function copyCard(index) {
            const cardToCopy = JSON.parse(JSON.stringify(cards[index]));
            cards.splice(index + 1, 0, cardToCopy);
            renderCardsList();
        }

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° DOM ---
        function updateCardDataFromDOM(element) {
            const cardEl = element.closest('.card');
            if (!cardEl) return;
            const index = parseInt(cardEl.dataset.index, 10);
            if (isNaN(index) || !cards[index]) return;
            const title = cardEl.querySelector('.card-title').textContent.trim();
            const subtitle = cardEl.querySelector('.card-subtitle').textContent.trim();
            const descriptionHTML = cardEl.querySelector('.card-content').innerHTML;
            const description = descriptionHTML
                .replace(/<br\s*[\/]?>/gi, "\n").replace(/<div>/gi, "\n")
                .replace(/<\/div>/gi, "").replace(/&nbsp;/g, " ")
                .replace(/<[^>]*>/g, '').trim();
            
            cards[index].title = title;
            cards[index].subtitle = subtitle;
            cards[index].description = description;
            cardCountEl.textContent = cards.length;
        }
        
        // --- –°–õ–£–®–ê–¢–ï–õ–ò ---
        function attachCardListeners() {
            document.querySelectorAll('.card[data-index]').forEach(cardEl => {
                cardEl.querySelector('.card-icon').addEventListener('click', (e) => {
                    openIconModal(e.currentTarget, parseInt(cardEl.dataset.index, 10));
                });
                cardEl.querySelectorAll('[contenteditable="true"]').forEach(field => {
                    field.addEventListener('input', () => adjustFontSize(field));
                    field.addEventListener('blur', () => updateCardDataFromDOM(field));
                });
            });
        }
        
        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ---
        function setupModalListeners() {
            modalBackdrop.onclick = closeIconModal;
        }

        function openIconModal(targetIcon, index) {
            modalEditingIndex = index;
            populateModalSelector();
            const rect = targetIcon.getBoundingClientRect();
            iconModal.style.display = 'block';
            modalBackdrop.style.display = 'block';
            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX - (iconModal.offsetWidth / 2) + (rect.width / 2);
            if (left < 10) left = 10;
            if (left + iconModal.offsetWidth > window.innerWidth - 10) {
                left = window.innerWidth - iconModal.offsetWidth - 10;
            }
            iconModal.style.top = `${top}px`;
            iconModal.style.left = `${left}px`;
        }

        function closeIconModal() {
            iconModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            modalEditingIndex = null;
        }

        function populateModalSelector() {
            modalIconSelector.innerHTML = '';
            defaultIconTypes.forEach(({ icon, type }) => {
                const option = document.createElement('div');
                option.className = 'icon-option';
                option.innerHTML = `
                    <div class="icon-emoji-box">${icon}</div>
                    <div class="icon-label">${type}</div>`;
                option.onclick = () => selectCardType(type);
                modalIconSelector.appendChild(option);
            });
        }
        
        function selectCardType(selectedType) {
            if (modalEditingIndex === null || !cards[modalEditingIndex]) return;
            const typeData = defaultIconTypes.find(t => t.type === selectedType);
            if (typeData) {
                cards[modalEditingIndex].type = typeData.type;
                cards[modalEditingIndex].icon = typeData.icon;
                renderCardsList();
            }
            closeIconModal();
        }
        
        // --- –ì–õ–ê–í–ù–ê–Ø –£–¢–ò–õ–ò–¢–ê ---
        function adjustFontSize(element) {
            if (!element || !(element.classList.contains('card-title') || element.classList.contains('card-subtitle'))) return;
            let maxFontSize, minFontSize, maxLines;
            if (element.classList.contains('card-title')) {
                maxFontSize = 20; minFontSize = 8; maxLines = 2;
            } else {
                maxFontSize = 12; minFontSize = 8; maxLines = 2;
            }
            const checkForOverflow = (el) => {
                const computedStyle = window.getComputedStyle(el);
                const maxWidth = el.clientWidth;
                ruler.style.font = computedStyle.font;
                ruler.style.letterSpacing = computedStyle.letterSpacing;
                ruler.style.textTransform = computedStyle.textTransform;
                const words = el.textContent.split(/\s+/);
                for (const word of words) {
                    ruler.textContent = word;
                    if (ruler.offsetWidth > maxWidth) return true;
                }
                const singleLineHeight = parseFloat(computedStyle.lineHeight);
                const maxHeight = (singleLineHeight * maxLines) + 1;
                return el.scrollHeight > maxHeight;
            };
            
            let currentSize = maxFontSize;
            element.style.fontSize = currentSize + 'px';
            while (currentSize > minFontSize && checkForOverflow(element)) {
                currentSize--;
                element.style.fontSize = currentSize + 'px';
            }
        }

        // --- –§–ê–ô–õ–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò ---
        function printCards() {
            if (cards.length === 0) return alert('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–µ—á–∞—Ç–∏!');
            window.print();
        }

        function saveJSON() {
            if (cards.length === 0) return alert('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
            const dataStr = JSON.stringify(cards, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'cards-data.json';
            a.click(); URL.revokeObjectURL(url);
        }

        function loadJSON() { fileInput.click(); }
        
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedCards = JSON.parse(e.target.result);
                    if (Array.isArray(loadedCards)) {
                        loadedCards.forEach(card => {
                            if (card.type && !card.icon) {
                                const typeData = defaultIconTypes.find(t => t.type === card.type);
                                card.icon = typeData ? typeData.icon : '‚ùì';
                            }
                        });
                        if (cards.length === 0 || confirm('–¢–µ–∫—É—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ?')) {
                            cards = loadedCards;
                            renderCardsList();
                            alert('–ö–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                        }
                    } else { alert('–û—à–∏–±–∫–∞: JSON —Ñ–∞–π–ª –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤).'); }
                } catch (err) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + err.message);
                } finally { fileInput.value = ''; }
            };
            reader.readAsText(file);
        }
        fileInput.addEventListener('change', handleFileLoad);

        function clearAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∫–∞—Ä—Ç–æ—á–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                cards = [];
                renderCardsList();
            }
        }
    </script>
</body>
</html>